<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/styles/default.min.css">
        <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>hljs.initLineNumbersOnLoad();</script>
        <style>
                @media (prefers-color-scheme: dark) {
                body {
                    background-color: #303030;
                }
                .hljs {
                    background-color: #424242;
                    ;
                }
                .hljs-ln-code {
                    color: #abb2bf;
                }
                }
                .hljs-ln-numbers {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                text-align: center;
                color: #ccc;
                border-right: 1px solid #CCC;
                vertical-align: top;
                padding-right: 10px !important;
                }
                .hljs-ln-code {
                padding-left: 10px !important;
                white-space: pre-wrap;
                }
        </style>
        <title>file: 9c3ce66fa62835b383367170a096fa45</title>
    </head>
    <body>
        <pre>
        <code>
var express = require(&#39;express&#39;);
var router = express.Router();

const multer = require(&#39;multer&#39;)
const fs = require(&#39;fs&#39;)
const path = require(&#39;path&#39;)
const dotenv = require(&#34;dotenv&#34;).config()
const uploadPath = path.join(__dirname, process.env.UPLOAD_PATH)
const crypto = require(&#39;crypto&#39;)
const mysql = require(&#39;mysql&#39;)
const mysqlConnect = require(&#39;./mysql&#39;)
const template = require(&#39;art-template&#39;)
const fsExtra = require(&#34;fs-extra&#34;);

/* GET home page. */
router.get(&#39;/&#39;, function (req, res, next) {
  res.send({
    success: true
  })
});

// 递归删除

/**
 * 删除文件夹下所有问价及将文件夹下所有文件清空
 * @param {*} path 
*/
function emptyDir(path) {
  const files = fs.readdirSync(path);
  files.forEach(file =&#62; {
    const filePath = `${path}/${file}`;
    const stats = fs.statSync(filePath);
    if (stats.isDirectory()) {
      emptyDir(filePath);
    } else {
      fs.unlinkSync(filePath);
      console.log(`删除${file}文件成功`);
    }
  });
}

/**
 * 删除指定路径下的所有空文件夹
 * @param {*} path 
 */
function rmEmptyDir(path, level = 0) {
  const files = fs.readdirSync(path);
  if (files.length &#62; 0) {
    let tempFile = 0;
    files.forEach(file =&#62; {
      tempFile++;
      rmEmptyDir(`${path}/${file}`, 1);
    });
    if (tempFile === files.length &#38;&#38; level !== 0) {
      fs.rmdirSync(path);
    }
  }
  else {
    level !== 0 &#38;&#38; fs.rmdirSync(path);
  }
}

/**
 * 清空指定路径下的所有文件及文件夹
 * @param {*} path 
 */
function clearDir(path) {
  emptyDir(path);
  rmEmptyDir(path);
}

// md5校验值生成函数
function md5(data) {
  // 以md5的格式创建一个哈希值
  let hash = crypto.createHash(&#39;md5&#39;);
  return hash.update(data).digest(&#39;base64&#39;);
}

// 上传接口
router.post(&#39;/api/upload&#39;, multer({
  dest: uploadPath,
  limits: {
    files: 5, // 最大上传5 个文件
    fieldSize: 5 * 1024 * 1024 // 最大上传 5 MB大小文本文件
  },
  fileFilter: (req, file, cb) =&#62; {
    // 判断为空后缀, 并允许通过
    if (file.mimetype == &#39;application/octet-stream&#39;) {
      return cb(console.log(&#39;The file suffix is empty, but it is allowed to receive as text.&#39;), true)
    }
    // 判断文件不为文本则new 一个error对象
    else if (!file.mimetype.match(/^text/)) {
      return cb(new Error(&#39;Only text are allowed.&#39;), false)
    }
    cb(null, true)
  }
}).array(&#39;file&#39;, 5), (req, res) =&#62; {
  // 接收全部文件对象
  const files = req.files
  // 创建存放所有文件信息得列表
  let fileList = []

  // mysql数据库连接信息
  const mysqlInfo = {
    PORT: process.env.DB_PORT,
    USER: process.env.DB_USER,
    PASSWORD: process.env.DB_PASSWORD,
    DATABASE: process.env.DB_DATABASE,
    HOST: process.env.DB_HOST,
  }
  const connection = mysqlConnect.connectMySQL(mysqlInfo)
  // 循环所有文件并修改文件名和路径属性
  for (var i in files) {
    // 变量 F 接收文件对象
    var F = files[i]
    // 获取文件名
    const userData = F
    mysqlConnect.addUserFileInfo(userData, mysqlInfo, connection)
    fileList.push(F)
    // 生成页面
    var htmlDir = path.join(__dirname, &#39;../pages&#39;)
    var htmlFileDirPath = path.join(htmlDir, F.filename)
    var htmlFilePath = path.join(htmlFileDirPath, &#39;./index.html&#39;)
    fs.mkdir(htmlFileDirPath, (err) =&#62; {
      if (err) console.error(err.message)
    })
    fs.readFile(path.join(__dirname, &#39;../views/pages/layout.html&#39;), (err, data) =&#62; {
      if (err) {
        console.log(`文件 ${path.join(__dirname, &#39;../views/pages/layout.html&#39;)} 读取错误`);
      } else {
        try {
          var fileData = fs.readFileSync(F.path, &#39;utf-8&#39;)
        } catch (err) {
          console.error(err.message)
        }

        let myData = data.toString()
        var result = template.render(myData, {
          content: fileData,
          fileName: `file: ${F.filename}`,
          cssUrl: &#34;//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/styles/default.min.css&#34;,
          jsUrl: &#34;//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/highlight.min.js&#34;
        })
        try {
          fs.writeFileSync(htmlFilePath, result)
          console.log(`生成html文件成功， 访问地址为: http://${req.headers.host}/p/${F.filename}`);
        } catch (err) {
          console.error(err.message)
        }
      }
    })
  }
  // 返回文件属性列表给用户
  res.send(fileList + &#39;\n&#39; + `生成html文件成功， 访问地址为: http://${req.headers.host}/p/${F.filename}`)
})

// 下载接口
router.get(&#39;/api/download&#39;, (req, res) =&#62; {
  req.query.file ? res.download(path.join(__dirname, process.env.UPLOAD_PATH, req.query.file)) : res.send({
    // 失败就返回 false
    success: false,
    message: &#39;下载失败，建议检查输入的文件名是否正确&#39;
  })
})

// 删除数据接口
router.get(&#39;/api/drop&#39;, (req, res) =&#62; {
  const mysqlInfo = {
    PORT: process.env.DB_PORT,
    USER: process.env.DB_USER,
    PASSWORD: process.env.DB_PASSWORD,
    DATABASE: process.env.DB_DATABASE,
    HOST: process.env.DB_HOST,
  }
  const connection = mysqlConnect.connectMySQL(mysqlInfo)
  req.query.file ? mysqlConnect.dropUserfile(connection, req.query.file) : res.send({
    success: false,
    message: &#39;删除失败，建议检查输入的文件名是否正确&#39;
  })
  var filePath = path.join(__dirname, `../upload/${req.query.file}`)
  fs.unlink(filePath, (err) =&#62; {
    if (err) {
      res.send(&#34;删除失败&#34; + err.message)
    }
    res.send(&#34;删除成功&#34;)
  })
  var htmlPath = path.join(__dirname, `../pages/${req.query.file}`)
  clearDir(htmlPath)
  fs.rmdir(htmlPath, err =&#62; {
    if (err) {
      res.send(&#34;删除失败&#34; + err.message)
    }
    console.log(&#34;删除成功&#34;)
  })
})


module.exports = router;

        </code>
    </pre>
    </body>

</html>